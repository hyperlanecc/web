---
title: "Post-Dispatch è·¨é“¾ Gas"
description: "ä½¿ç”¨ InterchainGasPaymaster åˆçº¦é…ç½®è·¨é“¾æ¶ˆæ¯ä¼ é€’çš„ gas æ”¯ä»˜"
---

åœ¨ post-dispatch hook æœŸé—´ï¼Œå¦‚æœæ”¯ä»˜ä¸è¶³ä»¥è¦†ç›– relayer çš„_é¢„æœŸ_æˆæœ¬ï¼Œ`InterchainGasPaymaster` åˆçº¦å°†å›æ»šã€‚åœ¨ `dispatch` æ—¶è®¡ç®—çš„ gas æŠ¥ä»·å¿…é¡»ä¸ relayer çš„é¢„æœŸæˆæœ¬ä¸€è‡´ã€‚

## Gas é™åˆ¶

`gasLimit` æ˜¯æ ¹æ®ç»™å®šæ¶ˆæ¯åœ¨ç›®æ ‡é“¾ä¸Šè°ƒç”¨ `handle` çš„æˆæœ¬è®¾ç½®çš„ã€‚è¿™å¯èƒ½å› æ¶ˆæ¯å†…å®¹å’Œå¤„ç†å™¨çš„é€»è¾‘è€Œå¼‚ã€‚

ç”¨äºè®¡é‡ handle è°ƒç”¨çš„é»˜è®¤ `gasLimit` æ˜¯é™æ€é»˜è®¤å€¼ `50_000` gasã€‚è¿™å¯¹äºç®€å•æ“ä½œæ¥è¯´è¶³å¤Ÿäº†ï¼Œä½†å¯¹äºæ›´å¤æ‚çš„ `handle` å‡½æ•°å¯èƒ½ä¸å¤Ÿã€‚

å¦‚æœæ‚¨çš„ `handle` å‡½æ•°æ‰§è¡Œå¤æ‚æ“ä½œæˆ–éœ€è¦æ›´å¤š gasï¼Œæ‚¨å¿…é¡»è¦†ç›–[å…ƒæ•°æ®ä¸­çš„é»˜è®¤ `gasLimit`](#metadata) ä»¥é¿å…äº¤æ˜“å›æ»šã€‚åœ¨å•å…ƒæµ‹è¯•ä¸­å¯¹æ‚¨çš„ [`handle` å®ç°](../messaging/receive#handle)è¿›è¡ŒåŸºå‡†æµ‹è¯•ï¼Œä»¥ç¡®å®šè¦ä½¿ç”¨çš„åˆç† `gasLimit`ã€‚

### å…ƒæ•°æ®

æ­¤ hook æœŸæœ›å…ƒæ•°æ®é‡‡ç”¨ `StandardHookMetadata` çš„**æ‰“åŒ…ç¼–ç **ã€‚æœ‰å…³å¦‚ä½•ä¼ é€’å…ƒæ•°æ®è¦†ç›–çš„ä¿¡æ¯ï¼Œè¯·å‚é˜… Mailbox [dispatch é‡è½½](../messaging/send#overriding-default-hook-metadata)ã€‚

```solidity
struct StandardHookMetadata {
    uint16 variant;
    uint256 msgValue;
    uint256 gasLimit;
    address refundAddress;
}
```

`StandardHookMetadata` ç»“æ„å®šä¹‰äº†å…ƒæ•°æ®ç¼–ç æ‰€éœ€çš„å­—æ®µï¼š

- `variant`ï¼šæŒ‡å®šå…ƒæ•°æ®æ ¼å¼ç‰ˆæœ¬ã€‚
- `msgValue`ï¼šéšæ¶ˆæ¯å‘é€çš„åŸç”Ÿä»£å¸æ•°é‡ã€‚
- `gasLimit`ï¼šç›®æ ‡é“¾ä¸Š `handle` å‡½æ•°çš„ gas é™åˆ¶ã€‚ç¡®ä¿è¿™ä¸æ‚¨çš„æ¨¡æ‹Ÿç»“æœåŒ¹é…ã€‚
- `refundAddress`ï¼šé€€è¿˜æœªä½¿ç”¨ gas æ”¯ä»˜çš„åœ°å€ã€‚

è¦ç¼–ç æ­¤å…ƒæ•°æ®ï¼Œè¯·ä½¿ç”¨ `StandardHookMetadata.formatMetadata` åº“å‡½æ•°ã€‚Solidity ä¸æ”¯æŒä½¿ç”¨ `abi.encodePacked` ç›´æ¥ç¼–ç ç»“æ„ä½“ã€‚

#### ä½¿ç”¨ç¤ºä¾‹

```solidity
// ç¤ºä¾‹ï¼šä½¿ç”¨ StandardHookMetadata ç¼–ç å…ƒæ•°æ®
bytes memory metadata = StandardHookMetadata.formatMetadata(
    0,               // ETH æ¶ˆæ¯å€¼
    200000,          // è‡ªå®šä¹‰ gas é™åˆ¶
    address(this),   // é€€æ¬¾åœ°å€
    bytes("")        // å¯é€‰çš„è‡ªå®šä¹‰å…ƒæ•°æ®
);
```

### ç¡®å®šå¹¶è¦†ç›– Gas é™åˆ¶

1. **æ¨¡æ‹Ÿå’ŒåŸºå‡†æµ‹è¯• Gas ä½¿ç”¨**ï¼š

- ä½¿ç”¨ Tenderly æˆ– Foundry ç­‰å·¥å…·æ¨¡æ‹Ÿæ¶ˆæ¯æ¥æ”¶è€…ä¸Šçš„ `handle` å‡½æ•°ã€‚ç¡®ä¿ `from` åœ°å€è®¾ç½®ä¸ºæ‚¨é“¾ä¸Šçš„ Mailbox åˆçº¦ã€‚
- å¦‚æœ gas ä½¿ç”¨è¶…è¿‡ `50,000` gasï¼Œè®¡ç®—é€‚å½“çš„ `gasLimit` å¹¶æ›´æ–°æ‚¨çš„å…ƒæ•°æ®ã€‚
- ä½¿ç”¨ [Hyperlane Explorer ä¸­çš„æ“ä½œæç¤º](https://github.com/hyperlane-xyz/hyperlane-explorer/blob/03634076049bfce1611b4e41d1aa81910eab2962/src/features/messages/cards/TransactionCard.tsx#L326-L333)ä»æ¶ˆæ¯è¯¦æƒ…æ¨¡æ‹Ÿäº¤æ˜“ã€‚

2. **æ›´æ–°æ‚¨çš„å…ƒæ•°æ®**ï¼š

- æ ¹æ®æ¨¡æ‹Ÿè®¡ç®—æ‰€éœ€çš„ `gasLimit`ã€‚
- åœ¨å…ƒæ•°æ®ä¸­ä¼ é€’æ›´æ–°çš„ `gasLimit`ï¼Œä»¥ç¡®ä¿ relayer å°†ä¼ é€’æ‚¨çš„æ¶ˆæ¯ã€‚

## ç›®æ ‡ Gas é…ç½®

å¯¹äºæ¯ä¸ªè¿œç¨‹åŸŸï¼ŒInterchainGasPaymaster è®¾ç½®åŸŸ gas é…ç½®ã€‚

```solidity
struct DomainGasConfig {
    IGasOracle gasOracle;
    uint96 gasOverhead;
}
```

### Gas å¼€é”€

gas å¼€é”€ä½œä¸ºç›®æ ‡ gas é…ç½®çš„ä¸€éƒ¨åˆ†è®¾ç½®ã€‚è¿™å¯¹åº”äºåœ¨ç›®æ ‡é“¾ä¸Šå¤„ç†æ¶ˆæ¯çš„æ“ä½œæˆæœ¬ã€‚

<Info>
  - æ‚¨åº”ç¡®ä¿ `gasOverhead` å……åˆ†è¦†ç›–ç›®æ ‡é“¾ä¸Šçš„ ISM èŒƒå›´ã€‚- ç”±äºæ‚¨å¯ä»¥ä¸ºä¸åŒçš„æ¶ˆæ¯ç±»å‹é…ç½®ä¸åŒçš„ ISMï¼Œæ¯ä¸ª ISM çš„ `verify` å‡½æ•°å¯èƒ½æœ‰ä¸åŒçš„ gas å¼€é”€ã€‚
</Info>

## Gas Oracle

è·¨é“¾ Gas æ”¯ä»˜è¦æ±‚æ˜¯ä½¿ç”¨æºé“¾å’Œç›®æ ‡é“¾ä¹‹é—´çš„é¢„è¨€æœºåŒ– gas ä»·æ ¼å’Œæ±‡ç‡è®¡ç®—çš„ã€‚

IGP åˆçº¦å¯ä»¥é…ç½® gas oracleï¼Œè´Ÿè´£è·Ÿè¸ªè¿œç¨‹ä»£å¸ gas ä»·æ ¼å’Œæ±‡ç‡ã€‚å¼€å‘è€…åº”ä½¿ç”¨ Mailbox åˆçº¦ä¸Šçš„ [`quoteDispatch`](/docs/protocol/core/post-dispatch-hooks-overview#quote-dispatch-fees) å‡½æ•°æ¥è®¡ç®— gas è´¹ç”¨ã€‚`quoteDispatch` è€ƒè™‘äº†ç³»ç»Ÿçº§å¼€é”€ï¼Œå¹¶ç¡®ä¿æ•´ä¸ª `dispatch` è¿‡ç¨‹çš„å‡†ç¡®è´¹ç”¨è®¡ç®—ã€‚

<Info>
  æ±‡ç‡å’Œ gas ä»·æ ¼ç”± relayer å†³å®šã€‚å¯èƒ½ä¼šæ”¶å–ä»·å·®ä»¥è€ƒè™‘æ¼‚ç§»å’Œè¿è¥æˆæœ¬ã€‚
</Info>

æœ€ç»ˆï¼Œrelayer å°†èƒ½å¤Ÿè‡ªåŠ¨æ›´æ–°å…¶ gas oracleï¼Œä»¥ç¡®ä¿å…¶ IGP å§‹ç»ˆä¸ºè¿œç¨‹ gas æŠ¥å‡ºå…¬å¹³ä»·æ ¼ã€‚

### `getExchangeRateAndGasPrice`

```solidity
function getExchangeRateAndGasPrice(
    uint32 destinationDomain
) external view returns (uint128 tokenExchangeRate, uint128 gasPrice);
```

**å‚æ•°**

- `destinationDomain`ï¼šæ¶ˆæ¯çš„ç›®æ ‡åŸŸ

**è¿”å›å€¼**

- `tokenExchangeRate`ï¼šæºé“¾å’Œç›®æ ‡é“¾ gas ä»£å¸ä¹‹é—´çš„æ±‡ç‡
- `gasPrice`ï¼šç›®æ ‡é“¾çš„ gas ä»·æ ¼

### `quoteGasPayment`

`quoteGasPayment` å‡½æ•°è®¡ç®— relayer é¢„æœŸæˆæœ¬çš„è´¹ç”¨ã€‚

```solidity
function quoteGasPayment(
    uint32 destinationDomain,
    uint256 gasLimit
) external view returns (uint256 fee);
```

**å‚æ•°**

- `destinationDomain`ï¼šæ¶ˆæ¯çš„ç›®æ ‡åŸŸ
- `gasLimit`ï¼šç”¨äºè®¡é‡ `handle` è°ƒç”¨çš„ gas é™åˆ¶

**è¿”å›å€¼**

- `fee`ï¼š`postDispatch` æˆåŠŸæ‰€éœ€çš„æ”¯ä»˜

<Info>
`quoteGasPayment` æ ¹æ® `destinationDomain` å’Œ `gasLimit` ç»™å‡ºä¼°ç®—è´¹ç”¨ã€‚ä½†æ˜¯ï¼Œå®ƒ**ä¸**åŒ…æ‹¬ Interchain Gas Paymasterï¼ˆIGPï¼‰ä¸ºé»˜è®¤ ISM æ”¯ä»˜æ·»åŠ çš„é¢å¤– gas æˆæœ¬ã€‚

è¦è·å¾—å®Œæ•´è´¹ç”¨ï¼Œè¯·ä½¿ç”¨ Mailbox åˆçº¦çš„ `quoteDispatch()`ã€‚å®ƒæä¾›åŒ…æ‹¬è¿™äº›é¢å¤–æˆæœ¬çš„å®Œæ•´æŠ¥ä»·ã€‚

ğŸ‘‰ æœ‰å…³æ›´å¤šè¯¦æƒ…ï¼Œè¯·å‚é˜… [Quote Dispatch](/docs/reference/messaging/send#quote-dispatch)ã€‚

</Info>

## é‡è¯•

å¦‚æœ `handle` è°ƒç”¨æ¶ˆè€—çš„ gas è¶…è¿‡æŠ¥ä»·ï¼Œrelayer å°†ä¸ä¼šæäº¤å¤„ç†äº¤æ˜“ã€‚æ­¤é—®é¢˜é€šå¸¸æ˜¯ç”±äºåˆå§‹ `dispatch` æœŸé—´ gas æ”¯ä»˜ä¸è¶³é€ æˆçš„ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ `payForGas` å‡½æ•°æ”¯ä»˜é¢å¤–çš„ gasã€‚

```solidity
function payForGas(
    bytes32 messageId,
    uint32 destinationDomain,
    uint256 gasAmount,
    address refundAddress
) external payable;
```

**å‚æ•°**

- `messageId`ï¼šä» `dispatch` è°ƒç”¨è¿”å›çš„æ¶ˆæ¯æ ‡è¯†ç¬¦
- `destinationDomain`ï¼šæ¶ˆæ¯çš„ç›®æ ‡åŸŸ
- `gasAmount`ï¼šè¦æ”¯ä»˜çš„é¢å¤– gas æ•°é‡
- `refundAddress`ï¼šé€€è¿˜å¤šä½™æ”¯ä»˜çš„åœ°å€

## ä½¿ç”¨ Hyperlane Explorer è¿›è¡Œè°ƒè¯•

Hyperlane Explorer æ˜¯è°ƒè¯•è·¨é“¾æ¶ˆæ¯é—®é¢˜ï¼ˆåŒ…æ‹¬ gas æ”¯ä»˜å’Œ relayer è¡Œä¸ºï¼‰çš„å¼ºå¤§å·¥å…·ã€‚

### å…³é”®åŠŸèƒ½

- **æ¶ˆæ¯çŠ¶æ€**ï¼šæŸ¥çœ‹æ¶ˆæ¯çš„å½“å‰çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œ"Retry: GasPaymentRequirementNotMet"ï¼‰ã€‚
- **Gas æ”¯ä»˜è¯¦æƒ…**ï¼šæ£€æŸ¥å·²æ”¯ä»˜çš„ gas æ•°é‡ï¼ˆæº IGP gas æ•°é‡ï¼‰å’Œ relayer æ‰€éœ€çš„æ•°é‡ã€‚
- **æ¨¡æ‹Ÿ Calldata**ï¼šä½¿ç”¨"æŸ¥çœ‹ calldata è¯¦æƒ…"é€‰é¡¹åœ¨ Tenderly ç­‰å·¥å…·ä¸Šæ¨¡æ‹Ÿäº¤æ˜“ã€‚

## æ•…éšœæ’é™¤

æœ¬èŠ‚æ¶µç›–å¼€å‘è€…åœ¨è·¨é“¾ Gas æ”¯ä»˜ä¸­é‡åˆ°çš„å¸¸è§é—®é¢˜åŠæ½œåœ¨è§£å†³æ–¹æ¡ˆã€‚

### `GasPaymentRequirementNotMet` è­¦å‘Š

- **åŸå› ï¼š** å½“ `dispatch` æœŸé—´æä¾›çš„ gas æ”¯ä»˜ä¸æ»¡è¶³ relayer çš„è®¡ç®—è¦æ±‚æ—¶å‘ç”Ÿã€‚

- **è§£å†³æ–¹æ¡ˆï¼š**
  - ä½¿ç”¨ `quoteDispatch` è®¡ç®— `dispatch` è°ƒç”¨æˆåŠŸæ‰€éœ€çš„æ€»è´¹ç”¨ã€‚
  - éªŒè¯å…ƒæ•°æ®ä¸­çš„ `msg.value` è¦†ç›– relayer çš„æŠ¥ä»·è´¹ç”¨ã€‚
  - åœ¨ Hyperlane Explorer ä¸­æ£€æŸ¥æ¶ˆæ¯çŠ¶æ€ã€‚æŸ¥æ‰¾ï¼š`Retry(GasPaymentRequirementNotMet)`ã€‚

### å›é€€è·¯ç”±å’Œè¶…é¢æ”¯ä»˜è­¦å‘Š

- **åŸå› ï¼š** `msg.value` è¶…è¿‡æ‰€éœ€çš„ gas æ”¯ä»˜ï¼Œè§¦å‘å›é€€è·¯ç”± hookã€‚

- **è§£å†³æ–¹æ¡ˆï¼š**
  - éªŒè¯æ‚¨çš„æŠ¥ä»·é€»è¾‘ï¼ˆ`quoteDispatch`ï¼‰ä¸ relayer çš„é¢„æœŸè´¹ç”¨åŒ¹é…ã€‚
  - é¿å…åœ¨æœªé¦–å…ˆå¯¹ `handle` å‡½æ•°è¿›è¡ŒåŸºå‡†æµ‹è¯•çš„æƒ…å†µä¸‹é«˜ä¼° `gasLimit` å€¼ã€‚
  - æ¨¡æ‹Ÿäº¤æ˜“ä»¥ç¡®è®¤é€‚å½“çš„æ”¯ä»˜ã€‚

### æ„å¤–å¤§çš„ Gas æŠ¥ä»·

- **åŸå› ï¼š** è®¾ç½®äº†éå¸¸é«˜çš„ `gasLimit`ï¼Œå¯¼è‡´è¿‡é«˜çš„ gas æŠ¥ä»·ã€‚

- **è§£å†³æ–¹æ¡ˆï¼š**

  - ä»”ç»†æ£€æŸ¥å…ƒæ•°æ®ä¸­æŒ‡å®šçš„ `gasLimit`ã€‚
  - éªŒè¯æ‚¨çš„æŠ¥ä»·é€»è¾‘ï¼ˆ`quoteDispatch`ï¼‰ä¸ relayer çš„é¢„æœŸè´¹ç”¨åŒ¹é…ã€‚
  - è°ƒæ•´ `gasLimit` ä»¥åŒ¹é… `handle` å‡½æ•°çš„ä¼°è®¡ gas æ¶ˆè€—ã€‚
