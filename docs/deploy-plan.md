# ðŸš€ Hyperlane é¡¹ç›®éƒ¨ç½²è„šæœ¬æ”¹è¿›æ–¹æ¡ˆ

## ðŸ“‹ å½“å‰è„šæœ¬é—®é¢˜åˆ†æž

### çŽ°æœ‰ deploy.sh çš„é—®é¢˜

1. **ä½¿ç”¨ npm è€Œéž pnpm**
   - ç¬¬ 45 è¡Œï¼š`npm ci --production=false`
   - ç¬¬ 48 è¡Œï¼š`npm run build`
   - ç¬¬ 67 è¡Œï¼š`pm2 start npm --name frontend -- start`

2. **ç¼ºå°‘ Git ä»“åº“é…ç½®**
   - æ²¡æœ‰æŒ‡å®šè¿œç¨‹ä»“åº“ URL
   - æ— æ³•ä»Žé›¶å¼€å§‹å…‹éš†é¡¹ç›®

3. **ç¼ºå°‘å¥åº·æ£€æŸ¥**
   - éƒ¨ç½²åŽæ²¡æœ‰éªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
   - æ²¡æœ‰æ£€æŸ¥ç«¯å£æ˜¯å¦å¯è®¿é—®

4. **ç¼ºå°‘å›žæ»šæœºåˆ¶**
   - éƒ¨ç½²å¤±è´¥æ—¶æ— æ³•è‡ªåŠ¨å›žæ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
   - æ²¡æœ‰ä¿å­˜éƒ¨ç½²åŽ†å²

5. **é”™è¯¯å¤„ç†ä¸å®Œå–„**
   - æŸäº›æ­¥éª¤å¤±è´¥åŽç»§ç»­æ‰§è¡Œ
   - æ²¡æœ‰è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

6. **ç¼ºå°‘çŽ¯å¢ƒæ£€æŸ¥**
   - æ²¡æœ‰æ£€æŸ¥å¿…è¦çš„å·¥å…·æ˜¯å¦å®‰è£…ï¼ˆpnpmã€goã€pm2 ç­‰ï¼‰
   - æ²¡æœ‰æ£€æŸ¥çŽ¯å¢ƒå˜é‡æ˜¯å¦é…ç½®

## ðŸŽ¯ æ”¹è¿›æ–¹æ¡ˆè®¾è®¡

### æ ¸å¿ƒåŠŸèƒ½

1. **å®Œæ•´çš„ Git é›†æˆ**
   - æ”¯æŒä»Žè¿œç¨‹ä»“åº“æ‹‰å–ä»£ç 
   - æ”¯æŒå­æ¨¡å—æ›´æ–°
   - è®°å½•éƒ¨ç½²ç‰ˆæœ¬ï¼ˆcommit hashï¼‰

2. **ä½¿ç”¨ pnpm**
   - æ›´å¿«çš„å®‰è£…é€Ÿåº¦
   - æ›´å°‘çš„ç£ç›˜å ç”¨
   - æ›´ä¸¥æ ¼çš„ä¾èµ–ç®¡ç†

3. **å¥åº·æ£€æŸ¥æœºåˆ¶**
   - å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥ï¼ˆHTTP è¯·æ±‚ï¼‰
   - åŽç«¯æœåŠ¡å¥åº·æ£€æŸ¥ï¼ˆAPI ç«¯ç‚¹ï¼‰
   - è¶…æ—¶å’Œé‡è¯•æœºåˆ¶

4. **è‡ªåŠ¨å›žæ»š**
   - ä¿å­˜ä¸Šä¸€ä¸ªæˆåŠŸçš„éƒ¨ç½²ç‰ˆæœ¬
   - éƒ¨ç½²å¤±è´¥æ—¶è‡ªåŠ¨å›žæ»š
   - æ‰‹åŠ¨å›žæ»šå‘½ä»¤æ”¯æŒ

5. **å®Œå–„çš„æ—¥å¿—**
   - å½©è‰²è¾“å‡ºï¼Œæ˜“äºŽé˜…è¯»
   - è¯¦ç»†çš„æ—¶é—´æˆ³
   - é”™è¯¯å †æ ˆè·Ÿè¸ª

6. **çŽ¯å¢ƒæ£€æŸ¥**
   - æ£€æŸ¥å¿…è¦å·¥å…·æ˜¯å¦å®‰è£…
   - éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨

### éƒ¨ç½²æµç¨‹å›¾

```mermaid
graph TD
    A[å¼€å§‹éƒ¨ç½²] --> B{çŽ¯å¢ƒæ£€æŸ¥}
    B -->|å¤±è´¥| Z[é€€å‡º]
    B -->|æˆåŠŸ| C[ä¿å­˜å½“å‰ç‰ˆæœ¬]
    C --> D[æ‹‰å–æœ€æ–°ä»£ç ]
    D --> E[æ›´æ–°å­æ¨¡å—]
    E --> F[å®‰è£…å‰ç«¯ä¾èµ– pnpm]
    F --> G[æž„å»ºå‰ç«¯]
    G --> H{æž„å»ºæˆåŠŸ?}
    H -->|å¤±è´¥| R[å›žæ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬]
    H -->|æˆåŠŸ| I[éƒ¨ç½²å‰ç«¯]
    I --> J{å‰ç«¯å¥åº·æ£€æŸ¥}
    J -->|å¤±è´¥| R
    J -->|æˆåŠŸ| K{æ˜¯å¦æœ‰åŽç«¯?}
    K -->|å¦| S[éƒ¨ç½²å®Œæˆ]
    K -->|æ˜¯| L[ç¼–è¯‘åŽç«¯]
    L --> M{ç¼–è¯‘æˆåŠŸ?}
    M -->|å¤±è´¥| R
    M -->|æˆåŠŸ| N[éƒ¨ç½²åŽç«¯]
    N --> O{åŽç«¯å¥åº·æ£€æŸ¥}
    O -->|å¤±è´¥| R
    O -->|æˆåŠŸ| P[æ¸…ç†æ—§å¤‡ä»½]
    P --> S
    R --> Z
    S --> T[è®°å½•éƒ¨ç½²æ—¥å¿—]
    T --> U[ç»“æŸ]
```

## ðŸ“ æ”¹è¿›åŽçš„è„šæœ¬åŠŸèƒ½æ¸…å•

### 1. é…ç½®ç®¡ç†
- [x] Git ä»“åº“ URL é…ç½®
- [x] åˆ†æ”¯é…ç½®ï¼ˆé»˜è®¤ mainï¼‰
- [x] éƒ¨ç½²ç›®å½•é…ç½®
- [x] æ—¥å¿—æ–‡ä»¶é…ç½®
- [x] å¤‡ä»½ä¿ç•™æ•°é‡é…ç½®

### 2. çŽ¯å¢ƒæ£€æŸ¥
- [x] æ£€æŸ¥ pnpm æ˜¯å¦å®‰è£…
- [x] æ£€æŸ¥ go æ˜¯å¦å®‰è£…
- [x] æ£€æŸ¥ pm2 æ˜¯å¦å®‰è£…
- [x] æ£€æŸ¥ systemctl æ˜¯å¦å¯ç”¨
- [x] æ£€æŸ¥å¿…è¦ç«¯å£æ˜¯å¦å¯ç”¨

### 3. Git æ“ä½œ
- [x] å…‹éš†ä»“åº“ï¼ˆé¦–æ¬¡éƒ¨ç½²ï¼‰
- [x] æ‹‰å–æœ€æ–°ä»£ç 
- [x] æ›´æ–°å­æ¨¡å—
- [x] è®°å½• commit hash
- [x] æ”¯æŒæŒ‡å®šåˆ†æ”¯/tag

### 4. å‰ç«¯éƒ¨ç½²
- [x] ä½¿ç”¨ pnpm å®‰è£…ä¾èµ–
- [x] ä½¿ç”¨ pnpm build æž„å»º
- [x] ä½¿ç”¨ pm2 ç®¡ç†è¿›ç¨‹
- [x] é›¶åœæœºé‡è½½ï¼ˆpm2 reloadï¼‰
- [x] å¥åº·æ£€æŸ¥ï¼ˆHTTP è¯·æ±‚ï¼‰

### 5. åŽç«¯éƒ¨ç½²
- [x] Go ä¾èµ–ä¸‹è½½
- [x] Go ç¼–è¯‘ä¼˜åŒ–
- [x] äºŒè¿›åˆ¶æ–‡ä»¶å¤‡ä»½
- [x] systemd æœåŠ¡é‡å¯
- [x] å¥åº·æ£€æŸ¥ï¼ˆAPI è¯·æ±‚ï¼‰

### 6. å›žæ»šæœºåˆ¶
- [x] ä¿å­˜ä¸Šä¸€ä¸ªæˆåŠŸç‰ˆæœ¬
- [x] è‡ªåŠ¨å›žæ»šï¼ˆéƒ¨ç½²å¤±è´¥æ—¶ï¼‰
- [x] æ‰‹åŠ¨å›žæ»šå‘½ä»¤
- [x] å›žæ»šåŽéªŒè¯

### 7. æ—¥å¿—å’Œé€šçŸ¥
- [x] å½©è‰²æ—¥å¿—è¾“å‡º
- [x] è¯¦ç»†çš„æ—¶é—´æˆ³
- [x] é”™è¯¯å †æ ˆè·Ÿè¸ª
- [x] éƒ¨ç½²æ‘˜è¦æŠ¥å‘Š

### 8. æ¸…ç†å’Œç»´æŠ¤
- [x] æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- [x] æ¸…ç†æ—§å¤‡ä»½
- [x] æ¸…ç†æ—§æ—¥å¿—
- [x] ç£ç›˜ç©ºé—´æ£€æŸ¥

## ðŸ”§ è„šæœ¬ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# æ ‡å‡†éƒ¨ç½²
./deploy.sh

# éƒ¨ç½²æŒ‡å®šåˆ†æ”¯
./deploy.sh --branch develop

# éƒ¨ç½²æŒ‡å®š tag
./deploy.sh --tag v1.0.0

# è·³è¿‡å¥åº·æ£€æŸ¥ï¼ˆä¸æŽ¨èï¼‰
./deploy.sh --skip-health-check

# ä»…éƒ¨ç½²å‰ç«¯
./deploy.sh --frontend-only

# ä»…éƒ¨ç½²åŽç«¯
./deploy.sh --backend-only

# å›žæ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
./deploy.sh --rollback

# æŸ¥çœ‹éƒ¨ç½²åŽ†å²
./deploy.sh --history

# æŸ¥çœ‹å¸®åŠ©
./deploy.sh --help
```

### é¦–æ¬¡éƒ¨ç½²

```bash
# 1. ç¡®ä¿æœåŠ¡å™¨å·²å®‰è£…å¿…è¦å·¥å…·
# 2. åˆ›å»ºéƒ¨ç½²ç›®å½•
mkdir -p /root/app/hyperlane.cc

# 3. ä¸‹è½½éƒ¨ç½²è„šæœ¬
cd /root/app/hyperlane.cc
curl -O https://raw.githubusercontent.com/hyperlane/web/main/deploy.sh
chmod +x deploy.sh

# 4. ç¼–è¾‘é…ç½®ï¼ˆå¦‚æžœéœ€è¦ï¼‰
nano deploy.sh
# ä¿®æ”¹ GIT_REPOã€BASE_DIR ç­‰é…ç½®

# 5. æ‰§è¡Œé¦–æ¬¡éƒ¨ç½²
./deploy.sh
```

### CI/CD é›†æˆ

è™½ç„¶å½“å‰æ˜¯æ‰‹åŠ¨æ‰§è¡Œï¼Œä½†è„šæœ¬è®¾è®¡æ”¯æŒæœªæ¥é›†æˆåˆ° CI/CDï¼š

```yaml
# GitHub Actions ç¤ºä¾‹ï¼ˆæœªæ¥å¯ç”¨ï¼‰
name: Deploy to Production
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /root/app/hyperlane.cc
            ./deploy.sh
```

## ðŸ“Š éƒ¨ç½²ç›‘æŽ§

### æ—¥å¿—ä½ç½®

```bash
# éƒ¨ç½²æ—¥å¿—
/var/log/hyperlane-deploy.log

# å‰ç«¯æ—¥å¿—
pm2 logs frontend

# åŽç«¯æ—¥å¿—
journalctl -u hyperlane-server -f

# Nginx æ—¥å¿—
/var/log/nginx/access.log
/var/log/nginx/error.log
```

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

```bash
# å‰ç«¯å¥åº·æ£€æŸ¥
curl http://localhost:3000

# åŽç«¯å¥åº·æ£€æŸ¥
curl http://localhost:8080/api/health
# æˆ–
curl http://localhost:8080/api/ping
```

## ðŸ”’ å®‰å…¨å»ºè®®

1. **é™åˆ¶è„šæœ¬æƒé™**
   ```bash
   chmod 700 deploy.sh
   chown root:root deploy.sh
   ```

2. **ä½¿ç”¨ SSH Key è€Œéžå¯†ç **
   - å·²åœ¨è„šæœ¬ä¸­ä½¿ç”¨ SSH å…‹éš†

3. **çŽ¯å¢ƒå˜é‡ä¿æŠ¤**
   - æ•æ„Ÿä¿¡æ¯ä¸è¦ç¡¬ç¼–ç 
   - ä½¿ç”¨ `.env` æ–‡ä»¶
   - `.env` æ–‡ä»¶ä¸è¦æäº¤åˆ° Git

4. **æ—¥å¿—è½®è½¬**
   ```bash
   # é…ç½® logrotate
   cat > /etc/logrotate.d/hyperlane << EOF
   /var/log/hyperlane-deploy.log {
       daily
       rotate 7
       compress
       delaycompress
       missingok
       notifempty
   }
   EOF
   ```

## ðŸŽ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **åˆ‡æ¢åˆ° Code æ¨¡å¼**å®žæ–½ä»¥ä¸‹ä¿®æ”¹ï¼š
   - åˆ›å»ºæ–°çš„ `deploy.sh` è„šæœ¬
   - æ›´æ–° `deploy.md` æ–‡æ¡£
   - åˆ›å»º `.env.example` è¡¥å……è¯´æ˜Ž

2. **æµ‹è¯•éƒ¨ç½²æµç¨‹**ï¼š
   - åœ¨æµ‹è¯•çŽ¯å¢ƒéªŒè¯
   - éªŒè¯å›žæ»šæœºåˆ¶
   - éªŒè¯å¥åº·æ£€æŸ¥

3. **æ–‡æ¡£å®Œå–„**ï¼š
   - æ›´æ–°éƒ¨ç½²æ•™ç¨‹
   - æ·»åŠ æ•…éšœæŽ’æŸ¥æŒ‡å—
   - æ·»åŠ æ€§èƒ½ä¼˜åŒ–å»ºè®®

## ðŸ“š å‚è€ƒèµ„æº

- [pnpm å®˜æ–¹æ–‡æ¡£](https://pnpm.io/)
- [PM2 å®˜æ–¹æ–‡æ¡£](https://pm2.keymetrics.io/)
- [Next.js éƒ¨ç½²æŒ‡å—](https://nextjs.org/docs/deployment)
- [Go ç¼–è¯‘ä¼˜åŒ–](https://golang.org/doc/install/source#environment)
- [systemd æœåŠ¡ç®¡ç†](https://www.freedesktop.org/software/systemd/man/systemd.service.html)